.rules_repo-account:
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_COMMIT_MESSAGE =~ /repo-account/'
      when: always
    - when: never

repo-account:lint:
  extends: .rules_repo-account
  image:
    name: sbtscala/scala-sbt:graalvm-community-24.0.1_1.11.2_3.7.1
    pull_policy: if-not-present
  stage: lint
  script:
    - cd apps/repo-account
    # TODO

repo-account:test:
  extends: .rules_repo-account
  image:
    name: sbtscala/scala-sbt:graalvm-community-24.0.1_1.11.2_3.7.1
    pull_policy: if-not-present
  stage: test
  # services:
  #   - name: mongo:8.0.6-noble
  #     alias: mongo
  #     pull_policy: if-not-present
  #   - name: redis:8.0-M04-alpine3.21
  #     alias: redis
  #     pull_policy: if-not-present
  #     command: ["redis-server","--requirepass", "admin"]
  #   - name: minio/minio:latest
  #     alias: minio
  #     pull_policy: if-not-present
  #     command: ["server","/data", "--console-address",":9001"]
  script:
    - sbt test

repo-account:build:
  extends: .rules_repo-account
  image:
    name: gcr.io/kaniko-project/executor:v1.23.2-debug
    entrypoint: [""]
    pull_policy: if-not-present
  stage: build
  variables:
    DOCKER_REGISTRY: $CI_REGISTRY
    DOCKER_IMAGE: $DOCKER_REGISTRY/repo-account
    DOCKER_TAG: $CI_COMMIT_TAG
  script:
    - echo "{\"auths\":{\"$DOCKER_REGISTRY\":{\"auth\":\"$(echo -n ${CI_REGISTRY_USER}:${CI_REGISTRY_PASSWORD} | base64)\"}}}" > /kaniko/.docker/config.json
    - /kaniko/executor --context . --dockerfile apps/Dockerfile --destination $DOCKER_IMAGE:$DOCKER_TAG
