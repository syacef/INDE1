apiVersion: sparkoperator.k8s.io/v1beta2
kind: ScheduledSparkApplication
metadata:
  name: srvc-stats-hourly
  namespace: spark
spec:
  schedule: "@every 1m"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  template:
    type: Scala
    mode: cluster
    sparkVersion: "3.5.5"
    image: "spark:3.5.5"
    imagePullPolicy: IfNotPresent
    mainClass: srvc_stats.MainHourly
    mainApplicationFile: "local:///opt/spark/app/srvc-stats-assembly-0.1.1.jar"
    volumes:
      - name: app-jar
        emptyDir:
          sizeLimit: 250Mi
      - name: gitlab-token
        secret:
          secretName: gitlab-token
          items:
            - key: token
              path: token
    restartPolicy:
      type: OnFailure
      onFailureRetries: 2
      onFailureRetryInterval: 10
      onSubmissionFailureRetries: 3
      onSubmissionFailureRetryInterval: 20
    timeToLiveSeconds: 1800
    sparkConf:
      "spark.executor.instances": "1"
      "spark.kubernetes.executor.deleteOnTermination": "true"
      "spark.kubernetes.driver.deleteOnTermination": "false"
      "spark.executor.heartbeatInterval": "10s"
      "spark.network.timeout": "120s"
    driver:
      initContainers:
        - name: download-jar
          image: curlimages/curl:latest
          command:
            - sh
            - -c
          args:
            - |
              curl -H "PRIVATE-TOKEN: $(cat /etc/gitlab-token/token)" \
                https://gitlab.cri.epita.fr/api/v4/projects/26539/packages/generic/srvc-stats/0.1.1/srvc-stats-assembly-0.1.1.jar \
                -o /opt/spark/app/srvc-stats-assembly-0.1.1.jar
          resources:
            limits:
              cpu: 50m
              memory: 0.25Gi
            requests:
              cpu: 50m
              memory: 0.25Gi
          volumeMounts:
            - mountPath: /opt/spark/app
              name: app-jar
            - mountPath: /etc/gitlab-token
              name: gitlab-token
              readOnly: true
      cores: 1
      coreLimit: 1000m
      coreRequest: 1
      memory: "512Mi"
      serviceAccount: spark-operator-spark
      labels:
        app: srvc-stats
        component: driver
      volumeMounts:
        - mountPath: /opt/spark/app
          name: app-jar
        - mountPath: /etc/gitlab-token
          name: gitlab-token
          readOnly: true
    executor:
      instances: 1
      cores: 1
      coreLimit: 1000m
      coreRequest: 1
      memory: "512Mi"
      labels:
        app: srvc-stats
        component: executor
